<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>JCache</title><link rel="stylesheet" type="text/css" href="eclipse_book.css"><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><meta name="keywords" content="ESB, Apache ServiceMix, Open Source, open source, integration, OSGi, enterprise service bus, Apache ServiceMix documentation, Apache Karaf, Red Hat JBoss Fuse, Red Hat JBoss Fuse documentation"><meta name="keywords" content="ESB, Apache ServiceMix, Open Source, open source, integration, OSGi, enterprise service bus, Apache ServiceMix documentation, Apache Karaf, Red Hat JBoss Fuse, Red Hat JBoss Fuse documentation"><link rel="home" href="index.html" title="Red Hat JBoss Fuse Tooling for Eclipse"><link rel="up" href="IDU-Components.html" title="Apache Camel Component Reference"><link rel="prev" href="IDU-JAXB.html" title="JAXB"><link rel="next" href="IDU-jclouds.html" title="jclouds"><link rel="copyright" href="tmdisclaim.html" title="Trademark Disclaimer"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="IDU-JCache"></a>JCache</h1></div></div></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e105280"></a>JCache Component</h2></div></div></div><p><span class="bold"><strong>Available as of Camel 2.17</strong></span></p><p>The j<span class="bold"><strong>cache</strong></span> component enables you to perform caching operations using JCache (JSR-107) as the Cache Implementation. The cache itself is created on demand or if a cache of that name already exists then it is simply utilized with its original settings.</p><p>This component supports producer and event based consumer endpoints.</p><p>The Cache consumer is an event based consumer and can be used to listen and respond to specific cache activities. If you need to perform selections from a pre-existing cache, use the processors defined for the cache component.</p><p>Maven users will need to add the following dependency to their <code class="code">pom.xml</code> for this component:</p><pre class="programlisting">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
    &lt;artifactId&gt;camel-jcache&lt;/artifactId&gt;
    &lt;version&gt;x.x.x&lt;/version&gt;
    &lt;!-- use the same version as your Camel core version --&gt;
&lt;/dependency&gt;</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e105302"></a>URI format</h2></div></div></div><pre class="programlisting">cache://cacheName[?options]</pre><p>You can append query options to the URI in the following format, <code class="code">?option=value&amp;option=#beanRef&amp;...</code></p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e105311"></a>Options</h2></div></div></div><table id="d0e105314"><tbody><tr><th><p>Name</p></th><th><p>Default Value</p></th><th><p>Description</p></th></tr><tr><td><p><code class="code">cachingProvider</code></p></td><td><p><code class="code">null</code></p></td><td><p>The fully qualified class name of the javax.cache.spi.CachingProvider. Mandatory in an OSGI environment.</p></td></tr><tr><td><p>cacheConfiguration</p></td><td><p><code class="code">null</code></p></td><td><p>A reference to a javax.cache.configuration.Configuration instance</p></td></tr><tr><td><p>cacheConfigurationProperties</p></td><td><p><code class="code">null</code></p></td><td><p>A reference to a java.util.Properties for the <code class="code">javax.cache.spi.CachingProvider</code> to create the javax.cache.CacheManager</p></td></tr><tr><td><p>configurationUri</p></td><td><p><code class="code">null</code></p></td><td><p>An implementation specific URI for the <code class="code">javax.cache.CacheManager</code></p></td></tr><tr><td><p>cacheLoaderFactory</p></td><td><p><code class="code">null</code></p></td><td><p>A reference to a <code class="code">javax.cache.configuration.Factory</code> for <code class="code">javax.cache.integration.CacheLoader</code></p></td></tr><tr><td><p>cacheWriterFactory</p></td><td><p><code class="code">null</code></p></td><td><p>A reference to a <code class="code">javax.cache.configuration.Factory</code> for <code class="code">javax.cache.integration.CacheWriter</code></p></td></tr><tr><td><p>expiryPolicyFactory</p></td><td><p><code class="code">null</code></p></td><td><p>A reference to a <code class="code">javax.cache.configuration.Factory</code> for <code class="code">javax.cache.expiry.ExpiryPolicy</code></p></td></tr><tr><td><p>readThrough</p></td><td><p><code class="code">false</code></p></td><td><p>A flag indicating if "read-through" mode is required</p></td></tr><tr><td><p>writeThrough</p></td><td><p><code class="code">false</code></p></td><td><p>A flag indicating if "write-through" mode is required</p></td></tr><tr><td>storeByValue</td><td>true</td><td>A flag indicating if the cache will be store-by-value or store-by-reference</td></tr><tr><td><p>statisticsEnabled</p></td><td><p><code class="code">fasle</code></p></td><td>
A flag indicating if statistics gathering is enabled</td></tr><tr><td><p>managementEnabled</p></td><td><p><code class="code">false</code></p></td><td>A flag indicating if management is enabled</td></tr><tr><td><p>filteredEvents</p></td><td><p><code class="code">null</code></p></td><td><p>A comma separated list of event types to filter. Overridden by eventFilters when they are specified together. </p></td></tr><tr><td><p>eventFilters</p></td><td><p><code class="code">null</code></p></td><td><p>A comma separated list of javax.cache.event.CacheEntryEventFilter references. Overrides filteredEvents when they are specified together.</p></td></tr><tr><td>oldValueRequired</td><td><code class="code">false</code></td><td>A flag indicating if the old value is required for events, supported values are CREATED, UPDATED, REMOVED, EXPIRED</td></tr><tr><td>synchronous</td><td>false</td><td>A flag indicating if the event listener should block the thread causing the event</td></tr><tr><td>action</td><td>null</td><td>The default action to apply, value in the header has the priority</td></tr><tr><td>createCacheIfNotExists</td><td>true</td><td>Configure if the cache identified by cacheName need to be created if it does not exists</td></tr></tbody></table></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e105524"></a>Header variables</h2></div></div></div><table id="d0e105527"><tbody><tr><th><p>Name</p></th><th><p>Type</p></th><th><p>Description</p></th></tr><tr><td><p>CamelJCacheAction</p></td><td><p><code class="code">java.lang.String</code></p></td><td><p>The action to perform, supported values are PUT, PUTALL, PUTIFABSENT, GET, GETALL, GETANDREMOVE, GETANDREPLACE, GETANDPUT, REPLACE, REMOVE, REMOVEALL, INVOKE, CLEAR</p></td></tr><tr><td><p>CamelJCacheResult</p></td><td><p><code class="code">java.lang.Object</code></p></td><td><p>The result of an action, i.e. Boolean for PUT, REMOVE, REPLACE</p></td></tr><tr><td><p>CamelJCacheEventType</p></td><td><p><code class="code">java.lang.String</code></p></td><td><p>The type of event <code class="code">javax.cache.event.EventType</code></p></td></tr><tr><td><p>CamelJCacheKey</p></td><td><p><code class="code">java.lang.Object</code></p></td><td><p>A key to apply an action</p></td></tr><tr><td>CamelJCacheKeys</td><td>java.util.Set&lt;java-lang.Object&gt;</td><td>A set of keys to apply an action, used for GETALL, REMOVEALL, INVOKE</td></tr><tr><td>CamelJCacheOldValue</td><td><code class="code">java.lang.Object</code></td><td>On consumer side, the header value contains the old value associated to a key. On producer side, the header must contains the expected old value to use CAS like operation</td></tr><tr><td>CamelJCacheEntryProcessor</td><td>javax.cache.processor.EntryProcessor</td><td>The entry processor to use for <code class="code">INVOKE</code> action</td></tr><tr><td>CamelJCacheEntryArgs</td><td><code class="code">java.util.collection&lt;java.lang.Object&gt;</code></td><td>Additional arguments to pass to the <code class="code">javax.cache.processor.EntryProcessor</code></td></tr></tbody></table><p> </p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e105622"></a>JCache based idempotent repository example:</h2></div></div></div><p> </p><pre class="programlisting">JCacheIdempotentRepository idempotentRepo = new JCacheIdempotentRepository();
idempotentRepo.setCacheName("idempotent-cache")
 
from("direct:in")
    .idempotentConsumer(header("messageId"), idempotentRepo)
    .to("mock:out");</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e105629"></a>JCache based aggregation repository example:</h2></div></div></div><pre class="programlisting">package org.apache.camel.component.jcache.processor.aggregate;

import org.apache.camel.EndpointInject;
import org.apache.camel.Exchange;
import org.apache.camel.Produce;
import org.apache.camel.ProducerTemplate;
import org.apache.camel.builder.RouteBuilder;
import org.apache.camel.component.mock.MockEndpoint;
import org.apache.camel.processor.aggregate.AggregationStrategy;
import org.junit.Test;

public class JCacheAggregationRepositoryRoutesTest extends JCacheAggregationRepositoryTestSupport {
    private static final String MOCK_GOTCHA = "mock:gotcha";
    private static final String DIRECT_ONE = "direct:one";
    private static final String DIRECT_TWO = "direct:two";
    @EndpointInject(uri = MOCK_GOTCHA)
    private MockEndpoint mock;
    @Produce(uri = DIRECT_ONE)
    private ProducerTemplate produceOne;
    @Produce(uri = DIRECT_TWO)
    private ProducerTemplate produceTwo;
    @Test
    public void checkAggregationFromTwoRoutes() throws Exception {
        final JCacheAggregationRepository repoOne = createRepository(false);
        final JCacheAggregationRepository repoTwo = createRepository(false);
        final int completionSize = 4;
        final String correlator = "CORRELATOR";
        RouteBuilder rbOne = new RouteBuilder() {
            @Override
            public void configure() throws Exception {
                from(DIRECT_ONE).routeId("AggregatingRouteOne")
                    .aggregate(header(correlator))
                    .aggregationRepository(repoOne)
                    .aggregationStrategy(new MyAggregationStrategy())
                    .completionSize(completionSize)
                    .to(MOCK_GOTCHA);
            }
        };
        RouteBuilder rbTwo = new RouteBuilder() {
            @Override
            public void configure() throws Exception {
                from(DIRECT_TWO).routeId("AggregatingRouteTwo")
                    .aggregate(header(correlator))
                    .aggregationRepository(repoTwo)
                    .aggregationStrategy(new MyAggregationStrategy())
                    .completionSize(completionSize)
                    .to(MOCK_GOTCHA);
            }
        };
        context().addRoutes(rbOne);
        context().addRoutes(rbTwo);
        context().start();
        mock.expectedMessageCount(1);
        mock.expectedBodiesReceived(1 + 2 + 3 + 4);
        produceOne.sendBodyAndHeader(1, correlator, correlator);
        produceTwo.sendBodyAndHeader(2, correlator, correlator);
        produceOne.sendBodyAndHeader(3, correlator, correlator);
        produceOne.sendBodyAndHeader(4, correlator, correlator);
        mock.assertIsSatisfied();
    }
    private class MyAggregationStrategy implements AggregationStrategy {
        @Override
        public Exchange aggregate(Exchange oldExchange, Exchange newExchange) {
            if (oldExchange == null) {
                return newExchange;
            } else {
                Integer n = newExchange.getIn().getBody(Integer.class);
                Integer o = oldExchange.getIn().getBody(Integer.class);
                Integer v = (o == null ? 0 : o) + (n == null ? 0 : n);
                oldExchange.getIn().setBody(v, Integer.class);
                return oldExchange;
            }
        }
    }
    protected JCacheAggregationRepository createRepository(boolean optimistic) throws Exception {
        JCacheAggregationRepository repository = new JCacheAggregationRepository();
        repository.setConfiguration(new JCacheConfiguration());
        repository.setCacheName("aggregation-repository");
        repository.setOptimistic(optimistic);
        return repository;
    }
}</pre></div></div></body></html>