<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Metrics Component</title><link rel="stylesheet" type="text/css" href="eclipse_book.css"><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><link rel="home" href="index.html" title="Red Hat JBoss Fuse Tooling for Eclipse"><link rel="up" href="IDU-Components.html" title="Part&nbsp;V.&nbsp;Apache Camel Component Reference"><link rel="prev" href="Mail-MailComponent.html" title="Mail Component"><link rel="next" href="MINA2-MINA2Component.html" title="MINA 2 Component"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="MetricsComponent-MetricsComponent"></a>Metrics Component</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-URIformat">URI format</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-options">Options</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-registryMetricRegistry">Metric Registry</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Usage">Usage</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-counterMetricstypecounter">Metrics type counter</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-histogramMetrictypehistogram">Metric type histogram</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-meterMetrictypemeter">Metric type meter</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-timerMetricstypetimer">Metrics type timer</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-MetricsRoutePolicyFactory">MetricsRoutePolicyFactory</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-MetricsMessageHistoryFactory">MetricsMessageHistoryFactory</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-InstrumentedThreadPoolFactory">InstrumentedThreadPoolFactory</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-SeeAlso">See Also</a></span></dt></dl></div><p><span class="strong"><strong>Available as of Camel 2.14</strong></span></p><p>The&nbsp;<span class="strong"><strong>metrics:</strong></span>&nbsp;component allows to collect various metrics directly
from Camel routes. Supported metric types
are&nbsp;<a class="link" href="MetricsComponent-MetricsComponent.html#MetricsComponent-counter">counter</a>,&nbsp;<a class="link" href="MetricsComponent-MetricsComponent.html#MetricsComponent-histogram">histogram</a>,
<a class="link" href="MetricsComponent-MetricsComponent.html#MetricsComponent-meter">meter</a>&nbsp;and&nbsp;<a class="link" href="MetricsComponent-MetricsComponent.html#MetricsComponent-timer">timer</a>.&nbsp;<a class="link" href="http://metrics.dropwizard.io" target="_top">Metrics</a>&nbsp;provides
simple way to measure behaviour of application. Configurable
reporting&nbsp;backend&nbsp;is enabling different integration options for
collecting and visualizing statistics. The component also provides
a&nbsp;<code class="literal">MetricsRoutePolicyFactory</code> which allows to expose route statistics
using Dropwizard Metrics, see bottom of page for details.</p><p>Maven users will need to add the following dependency to their <code class="literal">pom.xml</code>
for this component:</p><pre class="programlisting"><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.apache.camel<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>camel-metrics<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;version&gt;</strong>x.x.x<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
    <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">&lt;!-- use the same version as your Camel core version --&gt;</em>
<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-URIformat"></a>URI format</h2></div></div></div><pre class="screen">metrics:[ meter | counter | histogram | timer ]:metricname[?options]</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-options"></a>Options</h2></div></div></div><p>The Metrics component supports 1 options which are listed below.</p><p>{% raw %}</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="19%" class="col_1"><col width="11%" class="col_2"><col width="70%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Java Type</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>metricRegistry</p></td><td align="left" valign="top"><p><code class="literal">MetricRegistry</code></p></td><td align="left" valign="top"><p>To use a custom configured MetricRegistry.</p></td></tr></tbody></table></div><p>{% endraw %}</p><p>The Metrics component supports 8 endpoint options which are listed below:</p><p>{% raw %}</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="19%" class="col_1"><col width="10%" class="col_2"><col width="11%" class="col_3"><col width="10%" class="col_4"><col width="50%" class="col_5"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Group</th><th align="left" valign="top">Default</th><th align="left" valign="top">Java Type</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>metricsType</p></td><td align="left" valign="top"><p>producer</p></td><td align="left" valign="top">&nbsp;</td><td align="left" valign="top"><p><code class="literal">MetricsType</code></p></td><td align="left" valign="top"><p><span class="strong"><strong>Required</strong></span> Type of metrics</p></td></tr><tr><td align="left" valign="top"><p>metricsName</p></td><td align="left" valign="top"><p>producer</p></td><td align="left" valign="top">&nbsp;</td><td align="left" valign="top"><p><code class="literal">String</code></p></td><td align="left" valign="top"><p><span class="strong"><strong>Required</strong></span> Name of metrics</p></td></tr><tr><td align="left" valign="top"><p>action</p></td><td align="left" valign="top"><p>producer</p></td><td align="left" valign="top">&nbsp;</td><td align="left" valign="top"><p><code class="literal">MetricsTimerAction</code></p></td><td align="left" valign="top"><p>Action when using timer type</p></td></tr><tr><td align="left" valign="top"><p>decrement</p></td><td align="left" valign="top"><p>producer</p></td><td align="left" valign="top">&nbsp;</td><td align="left" valign="top"><p><code class="literal">Long</code></p></td><td align="left" valign="top"><p>Decrement value when using counter type</p></td></tr><tr><td align="left" valign="top"><p>increment</p></td><td align="left" valign="top"><p>producer</p></td><td align="left" valign="top">&nbsp;</td><td align="left" valign="top"><p><code class="literal">Long</code></p></td><td align="left" valign="top"><p>Increment value when using counter type</p></td></tr><tr><td align="left" valign="top"><p>mark</p></td><td align="left" valign="top"><p>producer</p></td><td align="left" valign="top">&nbsp;</td><td align="left" valign="top"><p><code class="literal">Long</code></p></td><td align="left" valign="top"><p>Mark when using meter type</p></td></tr><tr><td align="left" valign="top"><p>value</p></td><td align="left" valign="top"><p>producer</p></td><td align="left" valign="top">&nbsp;</td><td align="left" valign="top"><p><code class="literal">Long</code></p></td><td align="left" valign="top"><p>Value value when using histogram type</p></td></tr><tr><td align="left" valign="top"><p>synchronous</p></td><td align="left" valign="top"><p>advanced</p></td><td align="left" valign="top"><p><code class="literal">false</code></p></td><td align="left" valign="top"><p><code class="literal">boolean</code></p></td><td align="left" valign="top"><p>Sets whether synchronous processing should be strictly used or Camel is allowed to use asynchronous processing (if supported).</p></td></tr></tbody></table></div><p>{% endraw %}</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-registryMetricRegistry"></a><a name="MetricsComponent-registry"></a>Metric Registry</h2></div></div></div><p>Camel Metrics component uses by default a <code class="literal">MetricRegistry</code> instance with
a <code class="literal">Slf4jReporter</code> that has a 60 second reporting interval.
This default registry can be replaced with a custom one by providing
a <code class="literal">MetricRegistry</code> bean. If multiple <code class="literal">MetricRegistry</code> beans exist in the
application, the one with name <code class="literal">metricRegistry</code> is used.</p><p>For example using Spring Java Configuration:</p><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml"><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">public</strong> <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">static</strong> <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">class</strong> MyConfig <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">extends</strong> SingleRouteCamelConfiguration {

    <em xmlns="http://www.w3.org/1999/xhtml"><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em xmlns="http://www.w3.org/1999/xhtml"><span class="hl-annotation" style="color: gray">@Override</span></em>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">public</strong> RouteBuilder route() {
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">return</strong> <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">new</strong> RouteBuilder() {
            <em xmlns="http://www.w3.org/1999/xhtml"><span class="hl-annotation" style="color: gray">@Override</span></em>
            <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">public</strong> <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">void</strong> configure() <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">throws</strong> Exception {
                <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// define Camel routes here</em>
            }
        };
    }

    <em xmlns="http://www.w3.org/1999/xhtml"><span class="hl-annotation" style="color: gray">@Bean(name = MetricsComponent.METRIC_REGISTRY_NAME)</span></em>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">public</strong> MetricRegistry getMetricRegistry() {
        MetricRegistry registry = ...;
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">return</strong> registry;
    }
}</pre><p>Or using CDI:</p><pre class="programlisting"><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">class</strong> MyBean <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">extends</strong> RouteBuilder {

    <em xmlns="http://www.w3.org/1999/xhtml"><span class="hl-annotation" style="color: gray">@Override</span></em>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">public</strong> <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">void</strong> configure() {
      from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"..."</em></strong>)
          <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// Register the 'my-meter' meter in the MetricRegistry below</em>
          .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metrics:meter:my-meter"</em></strong>);
    }

    <em xmlns="http://www.w3.org/1999/xhtml"><span class="hl-annotation" style="color: gray">@Produces</span></em>
    <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// If multiple MetricRegistry beans</em>
    <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// @Named(MetricsComponent.METRIC_REGISTRY_NAME)</em>
    MetricRegistry registry() {
        MetricRegistry registry = <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">new</strong> MetricRegistry();
        <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// ...</em>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">return</strong> registry;
    }
}</pre><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="imagesdb/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top"><p><code class="literal">MetricRegistry</code> uses internal thread(s) for reporting. There is no
public API in version <code class="literal">3.0.1</code> for users to clean up on exit. Thus using
Camel Metrics Component leads to Java classloader leak and my cause
<code class="literal">OutOfMemoryErrors</code> in some cases.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-Usage"></a>Usage</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Headers">Headers</a></span></dt></dl></div><p>Each metric has type and name. Supported types are
<a class="link" href="MetricsComponent-MetricsComponent.html#MetricsComponent-counter">counter</a>,
<a class="link" href="MetricsComponent-MetricsComponent.html#MetricsComponent-histogram">histogram</a>,&nbsp;<a class="link" href="MetricsComponent-MetricsComponent.html#MetricsComponent-meter">meter</a>&nbsp;and
<a class="link" href="MetricsComponent-MetricsComponent.html#MetricsComponent-timer">timer</a>. Metric name is simple string. If
metric type is not provided then type meter is used by default.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Headers"></a>Headers</h3></div></div></div><p>Metric name defined in URI can be overridden by using header with name
<code class="literal">CamelMetricsName</code>.</p><p>For example</p><pre class="programlisting">from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .setHeader(MetricsConstants.HEADER_METRIC_NAME, constant(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"new.name"</em></strong>))
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metrics:counter:name.not.used"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre><p>will update counter with name <code class="literal">new.name</code> instead of <code class="literal">name.not.used</code>.</p><p>All Metrics specific headers are removed from the message once Metrics
endpoint finishes processing of exchange. While processing exchange
Metrics endpoint will catch all exceptions and write log entry using
level <code class="literal">warn</code>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-counterMetricstypecounter"></a><a name="MetricsComponent-counter"></a>Metrics type counter</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Options">Options</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Headers.1">Headers</a></span></dt></dl></div><pre class="screen">metrics:counter:metricname[?options]</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Options"></a>Options</h3></div></div></div><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="10%" class="col_2"><col width="80%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Default</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>increment&nbsp;</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>Long value to add to the counter</p></td></tr><tr><td align="left" valign="top"><p>decrement</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>Long value to subtract from the counter</p></td></tr></tbody></table></div><p>If neither <code class="literal">increment</code> or <code class="literal">decrement</code> is defined then counter value will
be incremented by one. If <code class="literal">increment</code> and <code class="literal">decrement</code> are both defined
only increment operation is called.&nbsp;</p><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// update counter simple.counter by 7</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:counter:simple.counter?increment=7"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// increment counter simple.counter by 1</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:counter:simple.counter"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// decrement counter simple.counter by 3</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:counter:simple.counter?decrement=3"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Headers.1"></a>Headers</h3></div></div></div><p>Message headers can be used to override <code class="literal">increment</code> and <code class="literal">decrement</code>
values specified in Metrics component URI.</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="79%" class="col_2"><col width="11%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Description</th><th align="left" valign="top">Expected type</th></tr></thead><tbody><tr><td align="left" valign="top"><p>CamelMetricsCounterIncrement&nbsp;</p></td><td align="left" valign="top"><p>Override increment value in URI</p></td><td align="left" valign="top"><p>Long</p></td></tr><tr><td align="left" valign="top"><p>CamelMetricsCounterDecrement&nbsp;</p></td><td align="left" valign="top"><p>Override decrement value in URI</p></td><td align="left" valign="top"><p>Long</p></td></tr></tbody></table></div><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// update counter simple.counter by 417</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .setHeader(MetricsConstants.HEADER_COUNTER_INCREMENT, constant(<span xmlns="http://www.w3.org/1999/xhtml" class="hl-number">417L</span>))
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:counter:simple.counter?increment=7"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// updates counter using simple language to evaluate body.length</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .setHeader(MetricsConstants.HEADER_COUNTER_INCREMENT, simple(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"${body.length}"</em></strong>))
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metrics:counter:body.length"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"mock:out"</em></strong>);</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-histogramMetrictypehistogram"></a><a name="MetricsComponent-histogram"></a>Metric type histogram</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Options.1">Options</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Headers.2">Headers</a></span></dt></dl></div><pre class="screen">metrics:histogram:metricname[?options]</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Options.1"></a>Options</h3></div></div></div><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="10%" class="col_2"><col width="80%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Default</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>value</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>Value to use in histogram</p></td></tr></tbody></table></div><p>If no <code class="literal">value</code> is not set nothing is added to histogram and warning is
logged.</p><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// adds value 9923 to simple.histogram</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:histogram:simple.histogram?value=9923"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// nothing is added to simple.histogram; warning is logged</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:histogram:simple.histogram"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Headers.2"></a>Headers</h3></div></div></div><p>Message header can be used to override value specified in Metrics
component URI.</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="79%" class="col_2"><col width="11%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Description</th><th align="left" valign="top">Expected type</th></tr></thead><tbody><tr><td align="left" valign="top"><p>CamelMetricsHistogramValue</p></td><td align="left" valign="top"><p>Override histogram value in URI</p></td><td align="left" valign="top"><p>Long</p></td></tr></tbody></table></div><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// adds value 992 to simple.histogram</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .setHeader(MetricsConstants.HEADER_HISTOGRAM_VALUE, constant(<span xmlns="http://www.w3.org/1999/xhtml" class="hl-number">992L</span>))
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:histogram:simple.histogram?value=700"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>)</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-meterMetrictypemeter"></a><a name="MetricsComponent-meter"></a>Metric type meter</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Options.2">Options</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Headers.3">Headers</a></span></dt></dl></div><pre class="screen">metrics:meter:metricname[?options]</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Options.2"></a>Options</h3></div></div></div><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="10%" class="col_2"><col width="80%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Default</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>mark&nbsp;</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>Long value to use as mark</p></td></tr></tbody></table></div><p>If <code class="literal">mark</code> is not set then&nbsp;<code class="literal">meter.mark()</code> is called without argument.</p><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// marks simple.meter without value</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:simple.meter"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// marks simple.meter with value 81</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:meter:simple.meter?mark=81"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Headers.3"></a>Headers</h3></div></div></div><p>Message header can be used to override <code class="literal">mark</code> value specified in Metrics
component URI.</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="79%" class="col_2"><col width="11%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Description</th><th align="left" valign="top">Expected type</th></tr></thead><tbody><tr><td align="left" valign="top"><p>CamelMetricsMeterMark</p></td><td align="left" valign="top"><p>Override mark value in URI</p></td><td align="left" valign="top"><p>Long</p></td></tr></tbody></table></div><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// updates meter simple.meter with value 345</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .setHeader(MetricsConstants.HEADER_METER_MARK, constant(<span xmlns="http://www.w3.org/1999/xhtml" class="hl-number">345L</span>))
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:meter:simple.meter?mark=123"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-timerMetricstypetimer"></a><a name="MetricsComponent-timer"></a>Metrics type timer</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Options.3">Options</a></span></dt><dt><span class="section"><a href="MetricsComponent-MetricsComponent.html#MetricsComponent-Headers.4">Headers</a></span></dt></dl></div><pre class="screen">metrics:timer:metricname[?options]</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Options.3"></a>Options</h3></div></div></div><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="10%" class="col_2"><col width="80%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Default</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>action</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>start or stop</p></td></tr></tbody></table></div><p>If no <code class="literal">action</code> or invalid value is provided then warning is logged
without any timer update. If action <code class="literal">start</code> is called on already running
timer or <code class="literal">stop</code> is called on not running timer then nothing is updated
and warning is logged.</p><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// measure time taken by route "calculate"</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metrics:timer:simple.timer?action=start"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:calculate"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metrics:timer:simple.timer?action=stop"</em></strong>);</pre><p><code class="literal">TimerContext</code> objects are stored as Exchange properties between
different Metrics component calls.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="MetricsComponent-Headers.4"></a>Headers</h3></div></div></div><p>Message header can be used to override action value specified in Metrics
component URI.</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="79%" class="col_2"><col width="11%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Description</th><th align="left" valign="top">Expected type</th></tr></thead><tbody><tr><td align="left" valign="top"><p>CamelMetricsTimerAction</p></td><td align="left" valign="top"><p>Override timer action in URI</p></td><td align="left" valign="top"><p><code class="literal">org.apache.camel.component.metrics.timer.TimerEndpoint.TimerAction</code></p></td></tr></tbody></table></div><pre class="programlisting"><em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// sets timer action using header</em>
from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:in"</em></strong>)
    .setHeader(MetricsConstants.HEADER_TIMER_ACTION, TimerAction.start)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"metric:timer:simple.timer"</em></strong>)
    .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"direct:out"</em></strong>);</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-MetricsRoutePolicyFactory"></a>MetricsRoutePolicyFactory</h2></div></div></div><p>This factory allows to add a&nbsp;<a class="link" href="routepolicy.html" target="_top">RoutePolicy</a> for each
route which exposes route utilization statistics using Dropwizard metrics.
This factory can be used in Java and XML as the examples below
demonstrates.&nbsp;</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="imagesdb/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Instead of using the MetricsRoutePolicyFactory you can define a
MetricsRoutePolicy per route you want to instrument, in case you only
want to instrument a few selected routes.</p></td></tr></table></div><p>From Java you just add the factory to the&nbsp;<code class="literal">CamelContext</code> as shown below:</p><pre class="programlisting">context.addRoutePolicyFactory(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">new</strong> MetricsRoutePolicyFactory());</pre><p>And from XML DSL you define a &lt;bean&gt; as follows:</p><pre class="programlisting">  <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">&lt;!-- use camel-metrics route policy to gather metrics for all routes --&gt;</em>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"metricsRoutePolicyFactory"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"org.apache.camel.component.metrics.routepolicy.MetricsRoutePolicyFactory"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong></pre><p>The&nbsp;<code class="literal">MetricsRoutePolicyFactory</code> and&nbsp;<code class="literal">MetricsRoutePolicy</code> supports the
following options:</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="10%" class="col_2"><col width="80%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Default</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>useJmx</p></td><td align="left" valign="top"><p>false</p></td><td align="left" valign="top"><p>Whether to report fine grained statistics to JMX by
using the <code class="literal">com.codahale.metrics.JmxReporter</code>.
Notice that if JMX is enabled on <a class="link" href="camelcontext.html" target="_top">CamelContext</a>
then a <code class="literal">MetricsRegistryService</code> mbean is enlisted under the services
type in the JMX tree. That mbean has a single operation to output the
statistics using json. Setting <code class="literal">useJmx</code> to true is only needed if you
want fine grained mbeans per statistics type.</p></td></tr><tr><td align="left" valign="top"><p>jmxDomain</p></td><td align="left" valign="top"><p>org.apache.camel.metrics</p></td><td align="left" valign="top"><p>The JMX domain name</p></td></tr><tr><td align="left" valign="top"><p>prettyPrint</p></td><td align="left" valign="top"><p>false</p></td><td align="left" valign="top"><p>Whether to use pretty print when outputting
statistics in json format</p></td></tr><tr><td align="left" valign="top"><p>metricsRegistry</p></td><td align="left" valign="top"><p>&nbsp;</p></td><td align="left" valign="top"><p>Allow to use a shared
<code class="literal">com.codahale.metrics.MetricRegistry</code>. If none is provided then Camel
will create a shared instance used by the this CamelContext.</p></td></tr><tr><td align="left" valign="top"><p>rateUnit</p></td><td align="left" valign="top"><p>TimeUnit.SECONDS</p></td><td align="left" valign="top"><p>The unit to use for rate in the metrics
reporter or when dumping the statistics as json.</p></td></tr><tr><td align="left" valign="top"><p>durationUnit</p></td><td align="left" valign="top"><p>TimeUnit.MILLISECONDS</p></td><td align="left" valign="top"><p>The unit to use for duration in
the metrics reporter or when dumping the statistics as json.</p></td></tr><tr><td align="left" valign="top"><p>namePattern</p></td><td align="left" valign="top"><p><code class="literal">##name##.##routeId##.##type##</code></p></td><td align="left" valign="top"><p><span class="strong"><strong>Camel 2.17:</strong></span> The name
pattern to use. Uses dot as separators, but you can change that. The
values <code class="literal">##name##</code>, <code class="literal">##routeId##</code>, and <code class="literal">##type##</code> will be replaced with actual
value. Where <code class="literal">##name##</code> is the name of the CamelContext. <code class="literal">##routeId##</code>
is the name of the route. And <code class="literal">##type##</code> is the value of responses.</p></td></tr></tbody></table></div><p>&nbsp;</p><p>From Java code tou can get hold of
the&nbsp;<code class="literal">com.codahale.metrics.MetricRegistry</code>&nbsp;from the
<code class="literal">org.apache.camel.component.metrics.routepolicy.MetricsRegistryService</code>
as shown below:</p><pre class="programlisting">MetricRegistryService registryService = context.hasService(MetricsRegistryService.<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">class</strong>);
<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">if</strong> (registryService != null) {
  MetricsRegistry registry = registryService.getMetricsRegistry();
  ...
}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-MetricsMessageHistoryFactory"></a>MetricsMessageHistoryFactory</h2></div></div></div><p><span class="strong"><strong>Available as of Camel 2.17</strong></span></p><p>This factory allows to use metrics to
capture&nbsp;<a class="link" href="message-history.html" target="_top">Message History</a> performance
statistics while routing messages. It works by using a metrics Timer for
each node in all the routes.&nbsp;This factory can be used in Java and XML as
the examples below demonstrates.&nbsp;</p><p>From Java you just set the factory to the&nbsp;<code class="literal">CamelContext</code>&nbsp;as shown below:</p><pre class="programlisting">context.setMessageHistoryFactory(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">new</strong> MetricsMessageHistoryFactory());</pre><p>And from XML DSL you define a &lt;bean&gt; as follows:</p><pre class="programlisting">  <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">&lt;!-- use camel-metrics message history to gather metrics for all messages being routed --&gt;</em>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"metricsMessageHistoryFactory"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"org.apache.camel.component.metrics.messagehistory.MetricsMessageHistoryFactory"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong></pre><p>The following options is supported on the factory:</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="10%" class="col_2"><col width="80%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Default</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>useJmx</p></td><td align="left" valign="top"><p>false</p></td><td align="left" valign="top"><p>Whether to report fine grained statistics to JMX by
using the <code class="literal">com.codahale.metrics.JmxReporter</code>.
Notice that if JMX is enabled on <a class="link" href="camelcontext.html" target="_top">CamelContext</a>
then a <code class="literal">MetricsRegistryService</code> mbean is enlisted under the services
type in the JMX tree. That mbean has a single operation to output the
statistics using json. Setting <code class="literal">useJmx</code> to true is only needed if you
want fine grained mbeans per statistics type.</p></td></tr><tr><td align="left" valign="top"><p>jmxDomain</p></td><td align="left" valign="top"><p>org.apache.camel.metrics</p></td><td align="left" valign="top"><p>The JMX domain name</p></td></tr><tr><td align="left" valign="top"><p>prettyPrint</p></td><td align="left" valign="top"><p>false</p></td><td align="left" valign="top"><p>Whether to use pretty print when outputting
statistics in json format</p></td></tr><tr><td align="left" valign="top"><p>metricsRegistry</p></td><td align="left" valign="top"><p>&nbsp;</p></td><td align="left" valign="top"><p>Allow to use a shared
<code class="literal">com.codahale.metrics.MetricRegistry</code>. If none is provided then Camel
will create a shared instance used by the this CamelContext.</p></td></tr><tr><td align="left" valign="top"><p>rateUnit</p></td><td align="left" valign="top"><p>TimeUnit.SECONDS</p></td><td align="left" valign="top"><p>The unit to use for rate in the metrics
reporter or when dumping the statistics as json.</p></td></tr><tr><td align="left" valign="top"><p>durationUnit</p></td><td align="left" valign="top"><p>TimeUnit.MILLISECONDS</p></td><td align="left" valign="top"><p>The unit to use for duration in
the metrics reporter or when dumping the statistics as json.</p></td></tr><tr><td align="left" valign="top"><p>namePattern</p></td><td align="left" valign="top"><p><code class="literal">##name##.##routeId##.##id##.##type##</code></p></td><td align="left" valign="top"><p>The name pattern
to use. Uses dot as separators, but you can change that. The values
<code class="literal">##name##</code>, <code class="literal">##routeId##</code>, <code class="literal">##type##</code>, and <code class="literal">##id##</code> will be replaced with
actual value. Where <code class="literal">##name##</code> is the name of the CamelContext.
<code class="literal">##routeId##</code> is the name of the route. The <code class="literal">##id##</code> pattern represents
the node id. And <code class="literal">##type##</code> is the value of history.</p></td></tr></tbody></table></div><p>At runtime the metrics can be accessed from Java API or JMX which allows
to gather the data as json output.</p><p>From Java code you can do get the service from the CamelContext as
shown:</p><pre class="programlisting">MetricsMessageHistoryService service = context.hasService(MetricsMessageHistoryService.<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">class</strong>);
String json = service.dumpStatisticsAsJson();</pre><p>And the JMX API the MBean is registered in the&nbsp;<code class="literal">type=services</code> tree
with&nbsp;<code class="literal">name=MetricsMessageHistoryService</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-InstrumentedThreadPoolFactory"></a>InstrumentedThreadPoolFactory</h2></div></div></div><p><span class="strong"><strong>Available as of Camel 2.18</strong></span></p><p>This factory allows you to gather performance information about Camel Thread Pools by injecting a InstrumentedThreadPoolFactory
which collects information from inside of Camel.
See more details at <a class="link" href="advanced-configuration-of-camelcontext-using-spring.html" target="_top">Advanced configuration of CamelContext using Spring</a></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MetricsComponent-SeeAlso"></a>See Also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">The <code class="literal">camel-example-cdi-metrics</code> example that illustrates the integration
between Camel, Metrics and CDI.</li></ul></div></div></div></body></html>