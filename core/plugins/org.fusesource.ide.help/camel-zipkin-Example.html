<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Example</title><link rel="stylesheet" type="text/css" href="eclipse_book.css"><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><meta name="keywords" content="ESB, Apache ServiceMix, Open Source, open source, integration, OSGi, enterprise service bus, Apache ServiceMix documentation, Apache Karaf, Red Hat JBoss Fuse, Red Hat JBoss Fuse documentation"><meta name="keywords" content="ESB, Apache ServiceMix, Open Source, open source, integration, OSGi, enterprise service bus, Apache ServiceMix documentation, Apache Karaf, Red Hat JBoss Fuse, Red Hat JBoss Fuse documentation"><link rel="home" href="index.html" title="Red Hat JBoss Fuse Tooling for Eclipse"><link rel="up" href="Zipkin-ZipkinComponent.html" title="Zipkin Component"><link rel="prev" href="camel-zipkin-Options.html" title="Options"><link rel="next" href="camel-zipkin-camel-zipin-starter.html" title="camel-zipin-starter"><link rel="copyright" href="tmdisclaim.html" title="Trademark Disclaimer"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="camel-zipkin-Example"></a>Example</h3></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="camel-zipkin-Example.html#camel-zipkin-ServiceName">ServiceName</a></span></dt><dt><span class="section"><a href="camel-zipkin-Example.html#camel-zipkin-ClientandServerServiceMappings">Client and Server Service Mappings</a></span></dt><dt><span class="section"><a href="camel-zipkin-Example.html#camel-zipkin-Mappingrules">Mapping rules</a></span></dt><dt><span class="section"><a href="camel-zipkin-Example.html#camel-zipkin-Noclientorservermappings">No client or server mappings</a></span></dt></dl></div><p>To enable camel-zipkin you need to configure first</p><pre class="programlisting">ZipkinTracer zipkin = <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">new</strong> ZipkinTracer();
<em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// configure the scribe span collector with the hostname and port for the Zipkin Collector Server</em>
zipkin.setSpanCollector(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">new</strong> ScribeSpanCollector(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"192.168.90.100"</em></strong>, <span xmlns="http://www.w3.org/1999/xhtml" class="hl-number">9410</span>);
<em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// and then add zipkin to the CamelContext</em>
zipkin.init(camelContext);</pre><p>The configuration above will trace all incoming and outgoing
messages in Camel routes.&nbsp;</p><p>To use ZipkinTracer in XML, all you need to do is to define scribe and
zipkin tracer beans. Camel will automatically discover and use them.</p><pre class="programlisting">  <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">&lt;!-- configure the scribe span collector with the hostname and port for the Zipkin Collector Server --&gt;</em>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"scribe"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"com.github.kristofa.brave.scribe.ScribeSpanCollector"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;constructor-arg</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">index</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"0"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">value</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"192.168.90.100"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;constructor-arg</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">index</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"1"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">value</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"9410"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/bean&gt;</strong>

  <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">&lt;!-- setup zipkin tracer --&gt;</em>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"zipkinTracer"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"org.apache.camel.zipkin.ZipkinTracer"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;property</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">name</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"serviceName"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">value</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"dude"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;property</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">name</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"spanCollector"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">ref</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"scribe"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/bean&gt;</strong></pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="camel-zipkin-ServiceName"></a>ServiceName</h4></div></div></div><p>However, if you want to map Camel endpoints to human friendly logical
names, you can add mappings</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">ServiceName *</li></ul></div><p>You can configure a global service name that all events will fallback
and use, such as:</p><pre class="programlisting">zipkin.setServiceName(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"invoices"</em></strong>);</pre><p>This will use the same service name for all incoming and outgoing zipkin
traces. If your application uses different services, you should map
them to more finely grained client / server service mappings</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="camel-zipkin-ClientandServerServiceMappings"></a>Client and Server Service Mappings</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">ClientServiceMappings</li><li class="listitem">ServerServiceMappings</li></ul></div><p>If your application hosts a service that others can call, you can map
the Camel route endpoint to a server service mapping. For example,
suppose your Camel application has the following route:</p><pre class="programlisting">from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"activemq:queue:inbox"</em></strong>)
  ...
  .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"http:someserver/somepath"</em></strong>);</pre><p>And you want to make that as a server service, you can add the following
mapping:</p><pre class="programlisting">zipkin.addServerServiceMapping(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"activemq:queue:inbox"</em></strong>, <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"orders"</em></strong>);</pre><p>Then when a message is consumed from that inbox queue, it becomes a
zipkin server event with the service name 'orders'.</p><p>Now suppose that the call to http:someserver/somepath is also a service,
which you want to map to a client service name, which can be done as:</p><pre class="programlisting">zipkin.addClientServiceMapping(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"http:someserver/somepath"</em></strong>, <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"audit"</em></strong>);</pre><p>Then in the same Camel application you have mapped incoming and outgoing
endpoints to different zipkin service names.</p><p>You can use wildcards in the service mapping. To match all outgoing
calls to the same HTTP server you can do:</p><pre class="screen">zipkin.addClientServiceMapping("http:someserver*", "audit");</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="camel-zipkin-Mappingrules"></a>Mapping rules</h4></div></div></div><p>The service name mapping for server occurs using the following rules</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Is there an exclude pattern that matches the endpoint uri of the
from endpoint? If yes then skip.</li><li class="listitem">Is there a match in the serviceServiceMapping that matches the
endpoint uri of the from endpoint? If yes, then use the found service name</li><li class="listitem">Is there a match in the serviceServiceMapping that matches the route
id of the current route? If yes, then use the found service name</li><li class="listitem">Is there a match in the serviceServiceMapping that matches the
original route id where the exchange started? If yes, then use the found
service name</li><li class="listitem">No service name was found, the exchange is not traced by zipkin</li></ol></div><p>The service name mapping for client occurs using the following rules</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Is there an exclude pattern that matches the endpoint uri of the
from endpoint? If yes then skip.</li><li class="listitem">Is there a match in the clientServiceMapping that matches the
endpoint uri of endpoint where the message is being sent to? If yes, then
use the found service name</li><li class="listitem">Is there a match in the clientServiceMapping that matches the route
id of the current route? If yes, then use the found service name</li><li class="listitem">Is there a match in the clientServiceMapping that matches the
original route id where the exchange started? If yes, then use the found
service name</li><li class="listitem">No service name was found, the exchange is not traced by zipkin</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="camel-zipkin-Noclientorservermappings"></a>No client or server mappings</h4></div></div></div><p>If there has been no configuration of client or server service mappings,
CamelZipkin runs in a fallback mode, and uses endpoint
uris as the service name.</p><p>In the example above, this would mean the service names would be defined as
if you add the following code yourself:</p><pre class="programlisting">zipkin.addServerServiceMapping(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"activemq:queue:inbox"</em></strong>, <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"activemq:queue:inbox"</em></strong>);
zipkin.addClientServiceMapping(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"http:someserver/somepath"</em></strong>, <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"http:someserver/somepath"</em></strong>);</pre><p>This is not a recommended approach, but gets you up and running quickly
without doing any service name mappings. However, when you have multiple
systems across your infrastructure, then you should consider using human-readable service names, that you map to instead of using the camel endpoint
uris.</p></div></div></body></html>